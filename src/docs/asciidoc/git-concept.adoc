= Git概念理解
贾明宇 <64896863@qq.com>
2018-08-17
:toc:
ifndef::imagesdir[:imagesdir: images]
ifndef::sourcedir[:sourcedir: ../../main/java]


== 阅读前提

阅读并能理解本文的前提：您是一名软件开发人员，之前有使用其他版本管理工具（比如svn）开发软件的经验。

== 是否应该学习Git

很多人有疑问，“我觉得svn已经足够好了，是否有学习git的必要？” +
我的经验是，如果您不是软件开发人员，并且想使用文件版本管理工具，svn已经足够用了。 +
对于软件开发人员来说，git比svn最大的优势在于代码分支管理。

== 去中心化与中心化管理

git为去中心化，svn为中心化。大家都习惯了中心化，是因为我们生活中大多数的事物都是中心化的。


[.thumb]
image::centvsdecent.png[Sunset,300,200]

.去中心化与中心化的例子
|===
|中心化 |去中心化

|svn
|git

|网站文件下载
|bt下载

|银行，央行
|加密货币

|警察局
|私家侦探，或者私自解决
|===

去中心化和中心化并不是谁比谁好的概念，而是各有优缺点，中心化效率高，但容易产生极权并滋生腐败，而去中心化更加公平自由，更容易产生创新，却很低效。 +
本文并不介绍git的去中心化概念，主要原因 1 去中心化概念理解复杂. 2 大多数时候我们使用git是在一个中心化环境中，比如公司中，最终代码是要提交到公司的代码库中，你私自保存并修改公司的代码是不合法的。

== 对软件分支的理解

=== 狭义的分支
最开始开发软件的时候，大家都很朴实，就是一块码代码呗，所以就没什么限制，改完代码就提交，这种模式在人少的时候还好，人一多的时候就出问题了，因为人多，产生错误的概率就越大， 我之前的一个公司，大约50人共同使用一个库，每天开发之前都不敢更新代码库，因为十有八九连最基本的编译都不过😂，更别提测试了。 +

这时候有人就想，能不能弄一套稳定的代码，然后我的任务以这个稳定的代码为基础开发，等我开发完，测试完之后，再合入这个稳定版本不就好了嘛。因此这个时候分支的概念就出来了，分支实际上是对软件的一种管理，它将代码的功能，稳定性隔离起来，更加方便。

=== 广义的分支
ps. 本节为选读。 +
分支在软件行业，尤其是开源软件中非常流行。但是它在各行各业都有。 +
牛顿曾经说过：如果说我看得比别人更远些，那是因为我站在巨人的肩膀上。这是因为，在人类历史中，任何行业的创新，都是基于原有的事物之上的，都是在合法“抄袭”，“山寨”别人的东西，取其精华，去其糟粕，才能创造出更好的东西。腾讯一直背负着抄袭的坏名声，我们不去讨论这些争议，但是最终人们选择了腾讯的产品，是因为腾讯能够“借鉴”别人的产品，并做得更好。我们今天使用的微软和苹果操作系统的界面，最早都是“借鉴”了施乐公司的产品。 +
因此广义的分支，则是借鉴现有的产品线，在其基础上再创作。而开源软件行业，大家提倡鼓励的就是软件的分享，因此分支更容易“借鉴”别人的软件，如果你喜欢别人的软件，直接fork一份自己去改就好了。

== Git比svn“奇怪”的地方
用惯了svn的同学，开始往往用svn的概念去套用git，然而二者相差太大，很多地方没法套用。

- 代码数据库的位置。svn中，你的工作目录中仅仅包括代码的文件，文件的历史记录在服务器的数据库中，你做的大部分操作（例如查看代码历史记录）都需要与服务器通讯。 而git环境中你的工作目录里不仅包括代码的文件，还包括所有文件的全部历史记录数据库，相当于把svn服务器的东西放本地了，你做的大部分操作（例如查看代码历史记录）都在本地完成，不需要与服务器通讯。这样的差别说明： 1. 这是中心化与去中心化的不同，git中你的本地和服务器是平等的，拥有同样的数据。 2. 由于所有的数据库在本地，git的操作相比svn非常快。 3. 由于所有的数据库在本地，git库中不推荐保存大文件（实际上任何版本管理工具都不应该保存大文件），这样会导致本地数据库巨大，并且影响操作性能。

- 分支的形式。我们用惯了电脑的人，往往用文件的形式理解分支，比如，我们svn中理想的分支是这样的：

[.thumb]
image::branchsvn.png[]

我们理所当然的认为，每个分支都是在#不同的#文件夹内，我们心里并没有切换分支的概念，因为不需要切换，想改哪个分支直接在相关的文件夹内修改，然后提交就可以了。 +
然而在git中分支却不是这样的，git中的分支：

[.thumb]
image::branchgit.png[]

这时候很多人就暗想，这不就是一个简单的项目文件夹么？我要的分支在哪里？ +
git中，#当前的工作目录指向的某个分支#，若你想使用其他分支，需要#手工切换#，切换后，当前工作目录里的文件会变成相关分支里的文件。很多同学这里不太理解，我的文件目录，难不成切换分之后会自己变动？是的，你没猜错，#切换分支后，git会根据本地数据库里该分支的数据，将工作目录中的文件替换成为该分支的文件#。

- 接上条，在svn的语境中，有人说：“提交到主干”，“提交到分支”，“从分支合并到主干”，这里主干和分支都指的是#远程服务器#，这几个概念非常简单。而git的语境中，主干和分支在#远程#和#本地#都存在，因此上面三句话的意思里，“提交”一定指的是提交代码到本地主干或分支，而“合并”，则有可能是从“本地分支1合并到本地分支2”，“从本地分支合并到本地主干”，“从本地分支1合并（push）到远程分支1”，异常复杂。大家尤其要思维清晰，清楚的知道你现在工作目录的分支状态，以及远程服务器的分支状态，不管是新开分支，或者是合并的时候，一定要保持代码最新，一定要#从远程服务器更新最新的代码到本地#。

[plantuml,git-local-and-remote]
----
@startuml
rectangle <<本机>> {
    cloud 工作目录 as workdir
	rectangle "本地主干" as lobalmaster
	rectangle "本地分支1" as localbranch1
	rectangle "本地分支2" as localbranch2
    workdir --> localbranch1
    workdir .. lobalmaster
    workdir .. localbranch2
    note right of workdir : 指向本地分支1
}

rectangle <<远程服务器>> {
	rectangle "远程主干"
	rectangle "远程分支1"
	rectangle "远程分支2"
}
@enduml
----

注意：本地主干和分支的版本状态随着时间是与远程主干和分支不同的，因此需要及时更新。

== svn中的问题在Git中的解决方法

老规矩先讲svn，svn经常出现的问题有几个：

1. 慢，更新的时候慢，提交的时候也慢。每次从服务器更新的时候，要么文件太多太碎，要么文件太大，要么同时更新的人太多，导致更新的时候巨慢无比。
2. 项目人数过多，代码更新频率太高，往往更新后导致代码跑步起来。
3. 多任务并行开发的时候乱套，开发人员往往依靠记忆力，只提交部分代码来应付相应的功能或任务。这种方式特别容易出错，另外多个任务的修改都在一个文件里，你没法把一个文件部分提交。

Git解决的方法：

1. Git提交操作是在本地，提交不需要时间。Git的更新由于是以二进制流进行下载，相对更快。
2. Git采用分支开发，提交，降低push频率，服务器github或gitlab开启代码审核，只有审核过或者通过测试的代码才允许合并到主干分支上。
3. 充分利用Git的分支功能，每一个任务创建一个分支，开发各个任务的时候灵活切换本地分支，按需分别提交分支的改动。

== Git的工作流程

这里我们以github或gitlab作为例子讲解Git一般的工作流程，虽然下面使用的是git命令行，但是笔者强烈建议使用ui工具例如tortoisegit来完成相应操作。

. 获取代码，使用git clone，此命令可以获取远程服务器的所有主干和分支数据，并且在本地工作目录显示主干的文件。
. 开始自己的开发任务，不管是bug或者是其他任务，每次应该新创建一个分支来开发。git checkout -b [name_of_your_new_branch] 注意此命令是以你本地的#当前分支#（一般来说是master）来创建新的分支。开发者应该养成良好的命名习惯，分支的名称最好以bug-xxxx, task-xxxx, feature-xxxx等命名，例如bug-修复18346。
. 开发结束后，使用git commit将改动提交到本地分支，然后git push将该分支推送到远程服务器。
. push之后，gitlab会根据你的配置来跑编译，静态检查，测试等任务，若出错，请返回上一步修改，若成功，则进行下一步。
. 在github或gitlab中创建一个merge request（github中叫pull request），意思是我请求将我这个改动的分支合并到主干中，请项目管理者批准。在此过程中，有可能会提示你你的代码和服务器冲突，无法自动合并，这时候你需要手动更新服务器最新代码到你的分支，并重新提交。
. 项目管理者会审核你的代码，若代码审核不通过，代码审核者或者通过工具，或者通过口头对你讲解代码的问题，开发者修改后重新上面的流程。
. 若代码审核过，你的代码会自动合并到主干，开发任务结束。

其他一些git操作：

. 列出本地的所有分支（可选），git branch，一般来说master是主干最新数据，分支是各个版本分支，tag是某个版本的快照。（当然master放最新或稳定代码这是项目管理者自己决策的）
. 切换到某个分支开始开发（可选），git checkout branchname


== 对代码冲突的理解

Git本身支持智能merge，也可以采用新开发流程来尽量减少冲突，但它并不能从根本上解决冲突，代码冲突表面上的原因在于多个人修改了同一个文件的同一部分。而#代码冲突的根本原因在于，大家合作上出了问题，正常的代码管理，应该是每个人负责不同的部分，而不是所有人可以修改所有的代码#。 +
因此出现冲突后，#首先需要做的不是解决冲突#，而是要#想一想两个人改了同样的一段代码的原因是什么#？或者是项目分配不当，亦或是沟通不畅。

